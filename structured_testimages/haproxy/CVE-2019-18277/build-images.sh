#!/bin/bash
if [ -z "$imagepath" ]; then 
    echo "imagepath unset"
    exit 1
fi

cd buildfiles
(cd baseimage && docker build -t debian_haproxy:baseimage .)
for dockerdir in $(find . -maxdepth 1 -mindepth 1 -type d | cut -c 3- | sort); do
    if [ $dockerdir == "baseimage" ]; then
        continue
    fi
    cd $dockerdir
    tag=$(echo $dockerdir | sed 's+.*/++')
    docker build -t debian_haproxy:$tag .
    #Consistent pushable tagging for tools that need to pull
    docker tag debian_haproxy:$tag $imagepath:debian_haproxy_$tag
    docker run $imagepath:debian_haproxy_$tag sh -c "haproxy -v"
    cd ..
    echo "  FROM $imagepath:debian_haproxy_$tag
            RUN  rm -rf /usr/sbin/haproxy && rm -rf /var/lib/haproxy && find / -iname \"*haproxy*\" -execdir rm -rf {} \; || : && find / -iname \"*haproxy*\" -execdir rm -rf {} \; || :" > Dockerfile
    docker build -t $imagepath:debian_haproxy_$tag"_deleted" .
    rm Dockerfile   
done