#!/bin/bash
if [ -z "$imagepath" ]; then
    echo "imagepath unset"
    exit 1
fi
cd buildfiles
(cd baseimage && docker build -t alpine_nginx:baseimage .)
for dockerdir in $(find . -maxdepth 1 -mindepth 1 -type d | cut -c 3- | sort); do
    if [ $dockerdir == "baseimage" ]; then
        continue
    fi
    cd $dockerdir
    tag=$(echo $dockerdir | sed 's+.*/++')
    docker build -t alpine_nginx:$tag .
    #Consistent pushable tagging for tools that need to pull
    docker tag alpine_nginx:$tag $imagepath:alpine_nginx_$tag
    docker run $imagepath:alpine_nginx_$tag sh -c "nginx -v"
    cd ..
    echo "  FROM $imagepath:alpine_nginx_$tag
            RUN  rm -rf /usr/sbin/nginx && find / -iname  nginx -exec rm -rf {} \; || : && find / -iname nginx -exec rm -rf {} \; || :" >Dockerfile
    docker build -t $imagepath:alpine_nginx_$tag"_deleted" .
    rm Dockerfile
done
