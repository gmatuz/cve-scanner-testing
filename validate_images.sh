#!/bin/bash
if [ -z "$imagepath" ]; then
    echo "imagepath unset"
    exit 1
fi
tags=$(wget -q https://registry.hub.docker.com/v1/repositories/$imagepath/tags -O -  | sed -e 's/[][]//g' -e 's/"//g' -e 's/ //g' | tr '}' '\n'  | awk -F: '{print $3}')

redis_deleted=$(echo "$tags" | grep redis | grep deleted)
redis=$(echo "$tags" | grep redis | grep -v  deleted)

nginx=$(echo "$tags" | grep nginx | grep -v deleted)
nginx_deleted=$(echo "$tags" | grep nginx | grep deleted)

haproxy=$(echo "$tags" | grep haproxy | grep -v deleted)
haproxy_deleted=$(echo "$tags" | grep haproxy | grep deleted)

tomcat=$(echo "$tags" | sed 's/ /\n/'  | grep tomcat | grep -v deleted)
tomcat_deleted=$(echo "$tags" | grep tomcat | grep deleted)

ruby=$(echo "$tags" | grep ruby | grep -v deleted)
ruby_deleted=$(echo "$tags" | grep ruby | grep deleted)

gunicorn=$(echo "$tags" | grep gunicorn | grep -v deleted)
gunicorn_deleted=$(echo "$tags" | grep gunicorn | grep deleted)

echo "$tags"

function test {
    tags=$1
    util=$2
    for tag in $tags; do
    	echo $tag
	if [[ $tag == *"baseimage"* ]]; then continue; fi
    	if [[ $tag == *"redis"* ]]; then docker run $imagepath:$tag sh -c "redis-server --version" ; fi
    	if [[ $tag == *"nginx"* ]]; then docker run $imagepath:$tag sh -c "nginx -v" ; fi
    	if [[ $tag == *"haproxy"* ]]; then docker run $imagepath:$tag sh -c "haproxy -v" ; fi
    	if [[ $tag == *"tomcat"* ]]; then docker run $imagepath:$tag sh -c "/opt/tomcat/bin/version.sh"; fi
    	if [[ $tag == *"ruby"* ]]; then docker run $imagepath:$tag sh -c "ruby -v"; fi
    	if [[ $tag == *"gunicorn"* ]]; then docker run $imagepath:$tag sh -c "gunicorn -v"; fi
   done
}


echo "starting test"
echo "redis, these should work"
test "$redis" "redis"
echo
echo "these should NOT"
test "$redis_deleted" "redis"
echo
echo
echo

echo "haproxy, these should work"
test "$haproxy" "haproxy"
echo
echo "these should NOT"
test "$haproxy_deleted" "haproxy"
echo
echo
echo

echo "nginx, these should work"
test "$nginx" "nginx"
echo
echo "these should NOT"
test "$nginx_deleted" "nginx"
echo
echo
echo

echo "ruby, these should work"
test "$ruby" "ruby"
echo
echo "these should NOT"
test "$ruby_deleted" "ruby"
echo
echo
echo

echo "tomcat, these should work"
test "$tomcat" "tomcat"
echo
echo "these should NOT"
test "$tomcat_deleted" "tomcat"


echo "gunicorn, these should work"
test "$gunicorn" "gunicorn"
echo
echo "these should NOT"
test "$gunicorn_deleted" "gunicorn"