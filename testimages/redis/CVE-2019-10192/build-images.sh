#!/bin/bash
if [ -z "$imagepath" ]; then 
    echo "imagepath unset"
    exit 1
fi

cd buildfiles
(cd baseimage && docker build -t alpine_redis:baseimage .)
for dockerdir in $(find . -maxdepth 1 -mindepth 1 -type d | cut -c 3- | sort); do
    if [ $dockerdir == "baseimage" ]; then
        continue
    fi
    cd $dockerdir
    tag=$(echo $dockerdir | sed 's+.*/++')
    docker build -t alpine_redis:$tag .
    #Consistent pushable tagging for tools that need to pull
    docker tag alpine_redis:$tag $imagepath:alpine_redis_$tag
    docker run $imagepath:alpine_redis_$tag sh -c "redis-server --version"
    cd ..
    echo "  FROM $imagepath:alpine_redis_$tag
            RUN  rm -rf /usr/local/bin && rm -rf /usr/bin/redis*" > Dockerfile
    docker build -t $imagepath:alpine_redis_$tag"_deleted" .
    rm Dockerfile   
done