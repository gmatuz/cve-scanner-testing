#!/bin/bash
if [ -z "$imagepath" ]; then 
    echo "imagepath unset"
    exit 1
fi

CWD=$(pwd)
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

for FOLDER in $DIR/buildfiles/*/     # list directories in the form "/tmp/dirname/"
do
	DIR_STRIPED=${FOLDER%*/}
	TAG=${DIR_STRIPED##*/}

	echo -n "----------- Building ${TAG} -----------"

	cd $FOLDER
	if [ -f "$FOLDER/download.sh" ]
	then
	  bash $FOLDER/download.sh
	fi

	cp $DIR/hello_world.rb $FOLDER
	docker build . -t cvescan_ruby_$TAG:CVE-2015-3900
    #Consistent pushable tagging for tools that need to pull
	docker tag cvescan_ruby_$TAG:CVE-2015-3900 $imagepath:debian_ruby_$TAG
	cd ..
    echo "  FROM $imagepath:debian_ruby_$TAG
            RUN  rm -rf /usr/bin/ruby* && find / -iname \"*ruby*\" -execdir rm -rf {} \; || : && find / -iname \"*ruby*\" -execdir rm -rf {} \; || :" > Dockerfile
    docker build -t $imagepath:debian_ruby_$TAG"_deleted" .
	docker run --entrypoint="" $imagepath:debian_ruby_$TAG"_deleted" find / -iname "*ruby*" 
    rm Dockerfile   

	rm $FOLDER/hello_world.rb

	if [ -f "$FOLDER/rm-downloaded.sh" ]
	then
	  bash $FOLDER/rm-downloaded.sh
	fi

done

cd $CWD

