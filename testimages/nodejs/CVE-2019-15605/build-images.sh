#!/bin/bash
if [ -z "$imagepath" ]; then
    echo "imagepath unset"
    exit 1
fi
cd buildfiles
(cd baseimage && docker build -t alpine_nodejs:baseimage .)
for dockerdir in $(find . -maxdepth 1 -mindepth 1 -type d | cut -c 3- | sort); do
    if [ $dockerdir == "baseimage" ]; then
        continue
    fi
    cd $dockerdir
    tag=$(echo $dockerdir | sed 's+.*/++')
    docker build -t alpine_nodejs:$tag .
    #Consistent pushable tagging for tools that need to pull
    docker tag alpine_nodejs:$tag $imagepath:alpine_nodejs_$tag
    docker run $imagepath:alpine_nodejs_$tag sh -c "node -v"
    cd ..
    echo "  FROM $imagepath:alpine_nodejs_$tag
            RUN  find / -iname  nodejs -exec rm -rf {} \; || : && find / -iname nodejs -exec rm -rf {} \; || :" >Dockerfile
    docker build -t $imagepath:alpine_nodejs_$tag"_deleted" .
    rm Dockerfile
done
