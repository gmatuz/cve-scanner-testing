#!/bin/bash
if [ -z "$imagepath" ]; then 
    echo "imagepath unset"
    exit 1
fi

cd buildfiles
(cd baseimage && docker build -t debian_gunicorn:baseimage .)
for dockerdir in $(find . -maxdepth 1 -mindepth 1 -type d | cut -c 3- | sort); do
    if [ $dockerdir == "baseimage" ]; then
        continue
    fi
    cd $dockerdir
    tag=$(echo $dockerdir | sed 's+.*/++')
    docker build -t debian_gunicorn:$tag .
    #Consistent pushable tagging for tools that need to pull
    docker tag debian_gunicorn:$tag $imagepath:debian_gunicorn_$tag
    docker run $imagepath:debian_gunicorn_$tag sh -c "gunicorn -v"
    cd ..
    echo "  FROM $imagepath:debian_gunicorn_$tag
            RUN  rm -rf /usr/local/lib/python2.7/dist-packages/gunicorn && rm -rf /usr/local/bin/gunicorn && find / -iname \"*gunicorn*\" -execdir rm -rf {} \; || :" > Dockerfile
    docker build -t $imagepath:debian_gunicorn_$tag"_deleted" .
    rm Dockerfile   
done