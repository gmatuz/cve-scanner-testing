#!/bin/bash
if [ -z "$imagepath" ]; then 
    echo "imagepath unset"
    exit 1
fi

CWD=$(pwd)
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

for FOLDER in $DIR/buildfiles/*/     # list directories in the form "/tmp/dirname/"
do
	DIR_STRIPED=${FOLDER%*/}
	TAG=${DIR_STRIPED##*/}

	echo -n "----------- Building ${TAG} -----------"

	cd $FOLDER
	if [ -f "$FOLDER/download.sh" ]
	then
	  bash $FOLDER/download.sh
	fi

	cp $DIR/build.properties $DIR/logging.properties $DIR/server.xml $FOLDER
	docker build . -t cvescan_tomcat_$TAG:CVE-2015-5351
    #Consistent pushable tagging for tools that need to pull
	docker tag cvescan_tomcat_$TAG:CVE-2015-5351 $imagepath:debian_tomcat_$TAG
    cd ..
    echo "  FROM $imagepath:debian_tomcat_$TAG
            RUN  rm -rf /usr/share/maven-repo && rm -rf /usr/share/tomcat8 && find / -iname \"*tomcat*\" -execdir rm -rf {} \; || : && find / -iname \"*tomcat*\" -execdir rm -rf {} \; || :" > Dockerfile
    docker build -t $imagepath:debian_tomcat_$TAG"_deleted" .
	docker run --entrypoint="" $imagepath:debian_tomcat_$TAG"_deleted" find / -iname "*tomcat*" 
    rm Dockerfile   

	rm $FOLDER/logging.properties $FOLDER/server.xml $FOLDER/build.properties

	if [ -f "$FOLDER/rm-downloaded.sh" ]
	then
	  bash $FOLDER/rm-downloaded.sh
	fi

done

cd $CWD

