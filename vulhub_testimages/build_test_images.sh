#!/bin/bash
if [ -z "$imagepath" ]; then
    echo "imagepath unset"
    exit 1
fi 
dir=$(pwd)
git clone https://github.com/vulhub/vulhub.git
rm ./images_to_scan
for dockerdir in $(find ./vulhub -name Dockerfile | grep CVE | sed 's-/Dockerfile--'); do
    CVE=$(echo "$dockerdir" | sed 's-.*/--')
    cd $dir/$dockerdir
    docker build -t $imagepath:$CVE .
    echo "$imagepath:$CVE $CVE">> $dir/images_to_scan
done
cd $dir/vulhub
grep -r image: . | grep CVE | grep vulhub | grep -v "vulhub/elasticsearch:5.6.16\|CVE-2017-12629-XXE\|CVE-2017-12629-RCE\|vulhub/zabbix:3.0.3\|weblogic" | sed 's-[^/]*/--' | sed 's+/docker.*image:++' | tr -d '\r' |  while read -r prebuilt ; do
    tokens=( $prebuilt )
    original_image=${tokens[1]}
    CVE=${tokens[0]}
    docker pull $original_image
    docker tag $original_image $imagepath:$CVE
    echo "$imagepath:$CVE  $CVE" >> $dir/images_to_scan
done
